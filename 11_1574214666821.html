<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>11</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <style type="text/css">
    button {
  background-color: #000;
  color: #fff;
  border: 0;
  font-size: 1em;
}
    </style>
  </head>
  <body>
    <div class="container">
    <br/>
    <div class="jumbotron">
        <p class="lead" id="greeting">请稍等 。。。</p>
        <hr/>
        <form id="form">
            <div class="form-group">
                <label for="name">您的姓名</label>
                <input type="text" class="form-control" id="name" placeholder="">
            </div>
            <div class="form-group">
                <label for="email">您的联系方式（不会公开显示）</label>
                <input type="email" class="form-control" id="email" placeholder="">
            </div>
            <div class="form-group">
                <label for="comment">您的意见</label>
                <input type="text" class="form-control" id="comment" placeholder="">
            </div>
            <button type="button" id="submit" class="btn btn-primary">发送</button>
        </form>
        <div id="formSubmitted" style="display:none">正在记录上链，请等 30 秒 ...</div>
    </div>
    
    <h4>已经确认的参会人</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">姓名</th>
                <th scope="col">意见</th>
            </tr>
        </thead>
        <tbody id="likes">
        </tbody>
    </table>
    <p style="text-align:center">Created with <a target="_blank" href="https://docs.secondstate.io/buidl-developer-tool/why-buidl">the BUIDL IDE</a>.</p>
</div>

    <script type="text/javascript">
    window.BuidlProviders = {
      web3: {
        url: "https://devchain.secondstate.io:8545",
        chainId: "27183",
        gasPrice: "0",
        gasLimit: "8192000000",
      },
      es: {
        url: "https://devchain.ss.search.secondstate.io"
      }
    }
    </script>
    <script type="text/javascript" src="https://buidl.secondstate.io/embed/main.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript">
    /* Don't modify */
var abi = [{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"disapprove","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"string"},{"name":"_email","type":"string"},{"name":"_comment","type":"string"}],"name":"addComment","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getAddrs","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"greetingApplied","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_greetingNew","type":"string"},{"name":"_greetingApplied","type":"string"},{"name":"_greetingApproved","type":"string"}],"name":"setGreetings","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getGreetings","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"greetingNew","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"greetingApproved","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"getComment","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"uint256"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_greetingNew","type":"string"},{"name":"_greetingApplied","type":"string"},{"name":"_greetingApproved","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];
var bytecode = '60806040523480156200001157600080fd5b50604051620017c5380380620017c5833981018060405281019080805182019291906020018051820192919060200180518201929190505050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508260019080519060200190620000a2929190620000de565b508160029080519060200190620000bb929190620000de565b508060039080519060200190620000d4929190620000de565b505050506200018d565b82805460018160011615610100020d166002900490600052602060002090601f016020900481019282601f106200012157805160ff191683800117855562000152565b8280016001018555821562000152579182015b828111156200015157825182559160200191906001019062000134565b5b50905062000161919062000165565b5090565b6200018a91905b80821115620001865760008160009055506001016200016c565b5090565b90565b611628806200019d6000396000f3006080604052600436106100a4576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806315770d99146100a957806339b92d17146100ec5780633f416eb3146101e15780637ce18c481461024d5780638c9eb8e3146102dd578063ca4c3a41146103d2578063d7b518a81461053a578063daea85c5146105ca578063dbdd70b41461060d578063f6bb0cf11461069d575b600080fd5b3480156100b557600080fd5b506100ea600480360381019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506108a4565b005b3480156100f857600080fd5b506101df600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506108ef565b005b3480156101ed57600080fd5b506101f6610a20565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561023957808201518184015260208101905061021e565b505050509050019250505060405180910390f35b34801561025957600080fd5b50610262610aae565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156102a2578082015181840152602081019050610287565b50505050905090810190601f1680156102cf5780820d805160018360200d6101000a0d1916815260200191505b509250505060405180910390f35b3480156102e957600080fd5b506103d0600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610b4c565b005b3480156103de57600080fd5b506103e7610bf1565b60405180806020018060200180602001848103845287818151815260200191508051906020019080838360005b8381101561042f578082015181840152602081019050610414565b50505050905090810190601f16801561045c5780820d805160018360200d6101000a0d1916815260200191505b50848103835286818151815260200191508051906020019080838360005b8381101561049557808201518184015260208101905061047a565b50505050905090810190601f1680156104c25780820d805160018360200d6101000a0d1916815260200191505b50848103825285818151815260200191508051906020019080838360005b838110156104fb5780820151818401526020810190506104e0565b50505050905090810190601f1680156105285780820d805160018360200d6101000a0d1916815260200191505b50965050505050505060405180910390f35b34801561054657600080fd5b5061054f610ddb565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561058f578082015181840152602081019050610574565b50505050905090810190601f1680156105bc5780820d805160018360200d6101000a0d1916815260200191505b509250505060405180910390f35b3480156105d657600080fd5b5061060b600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610e79565b005b34801561061957600080fd5b50610622610ec4565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610662578082015181840152602081019050610647565b50505050905090810190601f16801561068f5780820d805160018360200d6101000a0d1916815260200191505b509250505060405180910390f35b3480156106a957600080fd5b506106de600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610f62565b604051808060200180602001806020018681526020018060200185810385528a818151815260200191508051906020019080838360005b83811015610730578082015181840152602081019050610715565b50505050905090810190601f16801561075d5780820d805160018360200d6101000a0d1916815260200191505b50858103845289818151815260200191508051906020019080838360005b8381101561079657808201518184015260208101905061077b565b50505050905090810190601f1680156107c35780820d805160018360200d6101000a0d1916815260200191505b50858103835288818151815260200191508051906020019080838360005b838110156107fc5780820151818401526020810190506107e1565b50505050905090810190601f1680156108295780820d805160018360200d6101000a0d1916815260200191505b50858103825286818151815260200191508051906020019080838360005b83811015610862578082015181840152602081019050610847565b50505050905090810190601f16801561088f5780820d805160018360200d6101000a0d1916815260200191505b50995050505050505050505060405180910390f35b6003600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003018190555050565b6080604051908101604052808481526020018381526020018281526020016001815250600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082015181600001908051906020019061096d9291906114d7565b50602082015181600101908051906020019061098a9291906114d7565b5060408201518160020190805190602001906109a79291906114d7565b506060820151816003015590505060053390806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050505050565b60606005805480602002602001604051908101604052809291908181526020018280548015610aa457602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610a5a575b5050505050905090565b6002805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d16600290048015610b445780601f10610b1957610100808354040283529160200191610b44565b820191906000526020600020905b815481529060010190602001808311610b275782900d601f168201915b505050505081565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610ba757600080fd5b8260019080519060200190610bbd929190611557565b508160029080519060200190610bd4929190611557565b508060039080519060200190610beb929190611557565b50505050565b606080606060016002600382805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d16600290048015610c915780601f10610c6657610100808354040283529160200191610c91565b820191906000526020600020905b815481529060010190602001808311610c745782900d601f168201915b5050505050925081805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d16600290048015610d2d5780601f10610d0257610100808354040283529160200191610d2d565b820191906000526020600020905b815481529060010190602001808311610d105782900d601f168201915b5050505050915080805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d16600290048015610dc95780601f10610d9e57610100808354040283529160200191610dc9565b820191906000526020600020905b815481529060010190602001808311610dac5782900d601f168201915b50505050509050925092509250909192565b6001805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d16600290048015610e715780601f10610e4657610100808354040283529160200191610e71565b820191906000526020600020905b815481529060010190602001808311610e545782900d601f168201915b505050505081565b6002600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003018190555050565b6003805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d16600290048015610f5a5780601f10610f2f57610100808354040283529160200191610f5a565b820191906000526020600020905b815481529060010190602001808311610f3d5782900d601f168201915b505050505081565b606080606060006060806001600460008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301541415611059576002805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d1660029004801561104d5780601f106110225761010080835404028352916020019161104d565b820191906000526020600020905b8154815290600101906020018083116110305782900d601f168201915b505050505090506111e5565b6002600460008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301541415611146576003805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d1660029004801561113a5780601f1061110f5761010080835404028352916020019161113a565b820191906000526020600020905b81548152906001019060200180831161111d5782900d601f168201915b505050505090506111e4565b6001805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d166002900480156111dc5780601f106111b1576101008083540402835291602001916111dc565b820191906000526020600020905b8154815290600101906020018083116111bf5782900d601f168201915b505050505090505b5b600460008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600460008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600460008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201600460008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301548484805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d166002900480156113845780601f1061135957610100808354040283529160200191611384565b820191906000526020600020905b8154815290600101906020018083116113675782900d601f168201915b5050505050945083805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d166002900480156114205780601f106113f557610100808354040283529160200191611420565b820191906000526020600020905b8154815290600101906020018083116114035782900d601f168201915b5050505050935082805460018160011615610100020d166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020d166002900480156114bc5780601f10611491576101008083540402835291602001916114bc565b820191906000526020600020905b81548152906001019060200180831161149f5782900d601f168201915b50505050509250955095509550955095505091939590929450565b82805460018160011615610100020d166002900490600052602060002090601f016020900481019282601f1061151857805160ff1916838001178555611546565b82800160010185558215611546579182015b8281111561154557825182559160200191906001019061152a565b5b50905061155391906115d7565b5090565b82805460018160011615610100020d166002900490600052602060002090601f016020900481019282601f1061159857805160ff19168380011785556115c6565b828001600101855582156115c6579182015b828111156115c55782518255916020019190600101906115aa565b5b5090506115d391906115d7565b5090565b6115f991905b808211156115f55760008160009055506001016115dd565b5090565b905600a165627a7a72305820f9c035eb245008c31bf1bdc715724c0148475f7881d5793361144dc75fe240bc0029';
var cAddr = '0xf993cd7b0ac530d6bc26e12109e593d6829924ad';
/* Don't modify */

var instance = null;
window.addEventListener('web3Ready', function() {
  var contract = web3.ss.contract(abi);
  instance = contract.at(cAddr);
  reload();
});

function reload() {
    // instance.greeting(function (e, r) {
    //     $("#greeting").html(r);
    // });
    
    // $("#form").css("display", "block");
    $("#formSubmitted").css("display", "none");
    web3.ss.getAccounts(function (e, address) {
        if (!e) {
            instance.getComment(address, function (ee, result) {
                $("#greeting").html(result[4].replace("___", result[0]));
                console.log(result);
                if (result[3] == 1 || result[3] == 2) {
                    $("#form").css("display", "none");
                } else {
                    $("#form").css("display", "block");
                }
            });
            
            var likes = "";
            instance.getAddrs(function (ee, addrs) {
                addrs.forEach(function(addr) {
                    instance.getComment(addr, function (ee, r) {
                        if (!ee) {
                            if (r[3] == 2) {
                               likes = likes + "<tr><td>" + r[0] + "</td><td>" + r[2] + "</td></tr>";
                               $("#likes").html(likes);
                            }
                        }
                    });
                });
            });
            $("#likes").html(likes);
        }
    });
}

$("#submit").click(function() {
    if ((!$("#name").val().trim()) || (!$("#comment").val().trim())) {
      alert("请输入姓名与意见");
      return false;
    }
    web3.ss.getAccounts(function (e, address) {
        if (!e) {
            $("#form").css("display", "none");
            $("#formSubmitted").css("display", "block");
            instance.addComment ($("#name").val(), $("#email").val(), $("#comment").val(), {
                gas: 499000,
                gasPrice: 0
            }, function (ee, r) {
                if (ee) {
                    window.alert("Failed at " + address);
                }
            });
            setTimeout(function () {
                reload ();
            }, 25 * 1000);
        }
    });
    return false;
});
    </script>
  </body>
</html>